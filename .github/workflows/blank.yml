name: Build BusyBox ARM64 for Android

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-arm64-android:
    runs-on: ubuntu-latest

    steps:
      # 1. Checkout repository
      - name: Checkout
        uses: actions/checkout@v3

      # 2. Install dependencies
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential git wget bison flex libncurses-dev python3

      # 3. Download Android NDK
      - name: Download Android NDK
        run: |
          wget https://dl.google.com/android/repository/android-ndk-r25b-linux.zip
          unzip -q android-ndk-r25b-linux.zip
          mv android-ndk-r25b $HOME/android-ndk

      # 4. Download BusyBox source
      - name: Download BusyBox
        run: |
          wget https://busybox.net/downloads/busybox-1.36.1.tar.bz2
          tar xjf busybox-1.36.1.tar.bz2

      # 5. Configure BusyBox
      - name: Configure BusyBox
        run: |
          cd busybox-1.36.1
          make defconfig
          # Disable tc
          sed -i 's/CONFIG_TC=y/# CONFIG_TC is not set/' .config
          # Enable static linking
          sed -i 's/# CONFIG_STATIC is not set/CONFIG_STATIC=y/' .config

      # 6. Set NDK cross-compile environment
      - name: Set NDK cross-compile
        run: |
          export NDK=$HOME/android-ndk
          export TOOLCHAIN=$NDK/toolchains/llvm/prebuilt/linux-x86_64
          export PATH=$TOOLCHAIN/bin:$PATH
          export ARCH=arm64
          export CROSS_COMPILE=aarch64-linux-android-
          export CC=aarch64-linux-android21-clang
          export CXX=aarch64-linux-android21-clang++
          export AR=aarch64-linux-android-ar
          export AS=aarch64-linux-android-as
          export LD=aarch64-linux-android-ld
          export RANLIB=aarch64-linux-android-ranlib
          export STRIP=aarch64-linux-android-strip

      # 7. Build BusyBox
      - name: Build BusyBox
        run: |
          cd busybox-1.36.1
          make -j$(nproc)

      # 8. Upload the binary as artifact
      - name: Upload BusyBox binary
        uses: actions/upload-artifact@v3
        with:
          name: busybox-arm64-android
          path: busybox-1.36.1/busybox
