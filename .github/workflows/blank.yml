name: Build BusyBox ARM64

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-arm64:
    runs-on: ubuntu-latest

    steps:
      # 1. Checkout repository
      - name: Checkout
        uses: actions/checkout@v4

      # 2. Install dependencies
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential git libncurses-dev bison flex wget

      # 3. Download BusyBox source
      - name: Download BusyBox
        run: |
          wget https://busybox.net/downloads/busybox-1.36.1.tar.bz2
          tar xjf busybox-1.36.1.tar.bz2
          cd busybox-1.36.1

      # 4. Copy default config
      - name: Copy default config
        run: |
          cd busybox-1.36.1
          make defconfig

      # 5. Disable tc tool
      - name: Disable tc
        run: |
          cd busybox-1.36.1
          sed -i 's/CONFIG_TC=y/# CONFIG_TC is not set/' .config

      # 6. Set cross-compile for ARM64
      - name: Set cross-compile
        run: |
          cd busybox-1.36.1
          export ARCH=arm64
          export CROSS_COMPILE=aarch64-linux-gnu-

      # 7. Build BusyBox
      - name: Build BusyBox
        run: |
          cd busybox-1.36.1
          make -j$(nproc)

      # 8. Upload the binary as artifact
      - name: Upload BusyBox binary
        uses: actions/upload-artifact@v4
        with:
          name: busybox-arm64
          path: busybox-1.36.1/busybox

